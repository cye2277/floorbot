import os
from flask import Flask, request
from linebot import LineBotApi, WebhookHandler
from linebot.models import MessageEvent, TextMessage, TextSendMessage
import openai

app = Flask(__name__)

# ======== 1. 環境變數設定 ========
# 請將這些值設定成你自己的金鑰
LINE_CHANNEL_ACCESS_TOKEN = os.getenv('LINE_CHANNEL_ACCESS_TOKEN')
LINE_CHANNEL_SECRET = os.getenv('LINE_CHANNEL_SECRET')
OPENAI_API_KEY = os.getenv('OPENAI_API_KEY')

line_bot_api = LineBotApi(LINE_CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(LINE_CHANNEL_SECRET)
openai.api_key = OPENAI_API_KEY

# ======== 2. 模擬地板產品資料 ========
# floor_data = [
#     {"model": "DF-1001", "color": "淺木色", "waterproof": True, "price": 850, "thickness": 12},
#     {"model": "DF-1002", "color": "深木色", "waterproof": False, "price": 650, "thickness": 8},
#     {"model": "DF-1003", "color": "灰色", "waterproof": True, "price": 990, "thickness": 10}
# ]

knowledge_text = """
【公司願景﹠關於我們】
公司願景：Floors for living 為了豐富生活而生産製作的地板，要讓所有安裝地板的客戶，裝修更環保，家居更漂亮，享受優質的愜意生活！

詮倫企業股份有限公司是德國Kronotex地板在台灣的專業地板銷售公司。公司一系列引進德國Kronotex最新的產品。木地板從德國工廠直接到專賣店，沒有中間環節，價格實惠，力求台灣的消費者能得到與歐洲同步的地板產品，享受優質的家居生活。為了更好服務台灣的市場,公司另外成立翔騰國際建材有限公司、佳騰國際建材有限公司、喬思國際有限公司等關係企業，並在高雄台糖物流園區和台北五股華捷設立了物流倉儲，直接對台灣的Kronotex專賣店供貨，給客戶提供更為優質和快捷的服務。

基於對客戶全方位的服務，公司引進台灣首家Kronotex地板專賣店，讓客戶能在第一時間接觸到德國生產、原裝進口的環保優質超耐磨木地板。讓客戶能實際感受到，看到德國Kronotex各個系列的優質產品－買的稱心；用的放心。公司也將陸續在台灣各個主要縣市，結合有著相同理念，有環保意識的先進設立Kronotex專賣店，更好的服務每位台灣消費者。

維持森林的持續發展，更加合理經濟、有效的利用和研發世界森林資源，是德國高能得思地板一直以來秉持的理念。詮倫企業股份有限公司堅信經濟、生態、社會責任是三個不可分的概念。只有對社會有責任感的企業，才會帶給客戶更好的服務.
高能得思：高能得思是來自德國的地板品牌，以防水、耐磨、設計多樣著稱，產品包含強化木地板、SPC石塑地板與防水地板。

【德國總公司】
德國kronotex木業集團始建於1897年，公司總部位於德國柏林與漢堡之間勃蘭登堡州。是目前世界上規模最大、設備最先進的超耐磨木地板製造企業之一，年產量6000萬平方米，為世界上一百多個國家生產超耐磨地板。
一個跨越三個世紀的企業，經過一百多年磨煉，秉承卓越的傳統、雄厚的實力、先進的工藝、嚴格的環保標準和優秀的人文素質，打造出世界木材加工企業的航母，這就是德國kronotex木業集團。德國kronotex企業集團有著悠久的木材加工業歷史，是歐洲最大的超耐磨地板生產廠商，歷經漫長的歲月，始終在行業中居於領先地位，正如科隆大教堂在歐洲建築史中的成就和地位。
值得一提的是，在將歐洲最時尚的花式推進東方市場的同時，充分考慮到各種消費層次的需求，KRONOTEX擁有8mm 超高密度10mm 12mm超耐磨木地板，可供地熱供暖使用，物超所值，是性價比極佳的超耐磨木地板。KRONOTEX一貫堅持可持續發展戰略，保證市場供應的穩定性，同時將歐洲最時尚、最先進、最流行的產品源源不斷地引入東方市場
集團始終貫徹“全程操控”的原則，從林木的經營培育，到最終產品的製造都在集團的直接掌控之下，確保每一片地板產品都符合歐洲最高標準。在注重人居住環境的同時，集團最早獲得了歐洲最高環保標準“藍天使”認證，發起創建了“歐洲超耐磨木地板生產商協會（EPLF）”，並擔任該協會的常務副主席，組織並通過了高於歐洲質量標準的德國超耐磨木地板最高質量認證（RAL）。讓消費者買的放心，用的舒心。


【客戶評論】
1.台北內湖設計建材中心直營門市
鄭郁珠 ★★★★★
因為有過一次合作的經驗 第二次裝修依然選擇高能得思的產品 門市陳衣凡小姐認真負責的敬業態度 顏良安師傅專業精湛的木地板技藝 都是我再次回購的主因 優質的員工值得鼓勵 信任就是最佳的銷售

Leslie Kuo ★★★★★
好評： 品質, 守時, 專業度, 積極回應
為了搭配前屋主的地板找了很久，網路問了很多店家，最後因想看實體因緣際會走進這家品牌，Denny業務不會給人有壓力很隨和而且真誠的建議，就算問很多問題也耐心回答。他們搭配的師傅很不錯，有日本人的施工精神，很細心認真，施工過程很放心。Denny服務很好很專業，建議可以找他評估。

dennis rom ★★★★★
好評： 品質, 專業度
思樂推薦的木地板品質真的很好，完全符合我的期望我也要感謝施工人員的專業和耐心，他們在安裝過程中表現出色我家煥然一新，特別是我的孩子和妻子對新地板非常喜愛我會毫不猶豫地推薦給我的親朋好友。

2.台北內湖特力家居直營門市
巫小君 ★★★★★
為了改造舊房子的地板，比較了很多家木地板，來到高能德思遇到鄧小姐很細心又仔細的介紹，找了許多完工照片和拼法讓我了解，和家人討論之後決定下訂，成品比照片更好看，非常感謝她耐心的說明

看見台灣 ★★★★★
感謝熱心凱西的解說，我買的是高山貝格橡木，質感體驗極佳，直覺上對精神有極大的幫助，能療癒心靈，家庭成員都說好，已經是連續追買了，大推值得信賴

yingju liao ★★★★★
老公找到地板評價最好的德國高能得思地板 我們到內湖店剛好是凱西小姐服務我們的 不會因為我們施工的範圍很小 而隨便招待 整個在討論以及建議上都非常的實在 因為我們沒有找設計師全部都是自己來 所以有很多不懂之處 也問一大堆的問題 凱西小姐也非常不厭其煩地提醒我們要注意哪些事項 很符合我們的需求 完成品真的也超級贊 比我們之前想像的好很多 安裝工程師的實力很好 安裝後的垃圾 木屑也清理的很乾淨 整個品質真的沒有話說 有需求的朋友們真的可以找他們了解一下唷！

3.桃園南崁特力家居直營門市
A.W. ★★★★★
門市展示多種地板，還有樣板可以帶回去跟設計師討論。柳小姐介紹的很詳細，也能為客人設想幾種不同的搭配。最後決定選這間，施工的師傅非常專業又客氣。成品超有質感的，非常滿意。

王珮茹 ★★★★★
地板質感好、施工快速、符合預期。門市吳沛瀠小姐從洽談到完工，給予專業的建議及貼心的提醒，服務超棒

林姿吟 ★★★★★
從參觀吳小姐很細心～到丈量也都盡心盡力！連施工當天也到現場幫忙監工！有問題也都能得到相對回應！真的很謝謝這團隊！

4.新北中和HOLA直營門市
黃婷玉 ★★★★★
地板剛安裝完,業務陳耑瑜解說很詳細，有問題也很耐心說明有需求提出來討論也能提供專業建議施作團隊有4位師傅，工程比想像中快完成施工完成後覺得房子變得很有溫度。

dejeng dejeng (dejeng) ★★★★★
中和業務陳耑瑜服務一級棒，雖然我只安裝不到四坪，仍然優質，故推薦給大家。

鄧喬茵 ★★★★★
服務用心，說明專業，有耐心。地板美觀耐用，鋪設品質極佳，圓角部分處理，無可挑剔。

5.竹北HOLA直營門市
Guo-En Lin ★★★★★
門市邱先生很專業的介紹，建議的木板顏色很適合安裝空間。非常配合顧客的需求，安裝的師傅手法細膩，無論收邊或是施工後的環境清潔讓我們很滿意！大力推薦給還在尋找超耐磨木板的朋友們，一定不會失望！

吳青樺 ★★★★★
謝謝陳小姐在我們此次木地板工程中給予很完善的安排、很仔細的跟顧客提醒施作時的注意事項，遇上問題也能很迅速的協助處理；還有工班在施工時不論是在拆除跟鋪設都很細心。
真的是非常棒的團隊，讓我們有很舒適的成果。

Justin Wang ★★★★★
好評：品質,專業度
已經是我第二次回購 感謝彭小姐的細心解說和良好的服務品質,地板的選擇也很多,質感很不錯推薦給大家

6.台南仁德特力家居直營門市
Kyo Chen ★★★★★
來德國高能得思買木地板，下訂地板遇到劉小姐講解仔細服務好，來店購買要找劉小姐喔！ 

迷你世界:兔兔 ★★★★★
這次與貴公司購買地板從選購、安排日期、施工過程到結束都是一個愉快的經驗，謝謝林先生的接洽與服務，大力推薦！

馬妞 ★★★★★
好評： 值, 品質, 守時, 專業度, 積極回應
現場服務的劉小姐非常細心耐心的回答我們的問題，非常專業！甚至把木地板搬到隔壁的沙發區，讓我們比對新買的沙發顏色。整個購買流程非常的順暢，施工當天的年輕師傅們，非常專業以及施工品質都非常的好，施工結束後還把家具全部歸位，離開時也把環境打掃的非常乾淨！如果您有在找適合家裡的木地板，可以試試看他們家的專業服務與高品質哦！

7.高雄夢時代直營門市
Google Chen ★★★★★
好評： 值, 品質, 守時, 專業度, 積極回應
推周俞呈（周姐）的服務，耐心介紹產品，地板鋪後我跟內人都極度滿意成果

 
蔡榮杰 ★★★★★
好評： 品質, 專業度, 積極回應
業務服務人員態度親切，施工單位品質良好，如可搭配該公司活動價格優惠，推薦居家木質地板使用該公司產品。

Gary Chang ★★★★★
這是第二次選擇德國高能德思超耐磨地板，夢時代周小姐很專業推薦適合的產品，態度親切又專業的解說，這是選購白色宏觀木，施工完大人小孩都非常滿意，很推薦大家來購買!


8.高雄左營特力家居直營門市
林企茹 ★★★★★
去門市推薦蔡小姐，服務仔細而且有問題都認真回覆，看現場有疑問也是幫忙快速找師傅討論出解決方式

ao H ★★★★★
門市服務專員都非常專業，很有耐心的詳細介紹，非常推薦來這邊選購地板。

Alline Chen ★★★★★
感謝門市小姐的細心和施工師傅的用心，讓我們家的木地板可以順利修復，謝謝

【地板種類】
德國高能得思地板有歐洲最新、最頂級、最酷的超耐磨木地板，包含12個系列，共有100多種花色，還有你沒看過的地板，可以仔細挑選。若需索取樣品，可以點選地板花色的愛心red heart，加入追蹤清單，可以選擇《門市取樣》或是《送樣到府》（1～5個型號花色）。
強化木地板：由高密度纖維板製成，表面有耐磨層，外觀仿木紋，價格實惠、耐刮耐磨。
SPC地板：石塑複合地板，具備完全防水、穩定不變形的特性，適合廚房或商業空間。
工程木地板：表層真實木材，底層穩定結構，兼具質感與實用性。


【門市訊息】
1.台北內湖特力家居
台北市內湖區新湖三路23號2F R

特力家居 2樓

TEL: 02-2796-2238

FAX: 02-2796-2722

營業時間:10:00~22:00 (全年無休)

公車大眾運輸:下車站牌名稱－路線名稱，新湖三路口 聯營公車－ 204、518、藍7、小2、棕1

停車停車資訊:新湖三路23號地上3、4樓

2.台北內湖設計建材中心
台北市內湖區新湖一路185號3F306室 地圖

設計建材中心 3樓306室

TEL: 02-8791-1752

FAX: 02-8792-8745

營業時間:10:30~19:30

公車大眾運輸:公車路線:204、518、63、207、藍 7、552、 950、藍 50、綠 16、小 2，至「新湖一路口」下車，步行 3 分鐘即可抵達。

停車停車資訊:地下停車場

3.新莊紐約家具設計中心
新北市新莊區思源路553號2樓 R

紐約家具設計中心-新莊思源旗艦館 2樓

TEL: 02-2246-3280、02-2246-1416

FAX: 02-2246-2010

營業時間:12:00~21:00 (全年無休)

公車大眾運輸:1.搭乘捷運藍線從新埔站轉乘 : 搭乘918.813 至頭前國中(中原路)往思源路方向，直走步行600公尺即可到達本館。
                   2.從新北市捷運環狀線 : 轉機場捷運線A3新北產業園區站出口，往思源路方向直走步行750公尺即可到達本館。
                   3.搭乘機場捷運線 : 從A3新北產業園區站出口，往思源路方向直走步行750公尺即可抵達。

停車停車資訊:新申辦會員無消費或會員無消費，可折抵1小時；會員無消費，有提供估價單或業代陪同，可折抵2小時；會員有消費最高可折抵3小時。

4.桃園南崁特力家居
桃園市蘆竹區中正路1號B1-05建材館 R

國道1號-南坎交流道旁 特力家居 地下1樓

TEL: 03-212-0837

FAX: 03-212-0805

營業時間:11:00~22:00 (全年無休)

公車大眾運輸:3路公車-菜公路口站(美術館站-警廣站).72路公車-菜公路口站(獅甲國小-金獅湖站) .91路公車-菜公路口站(大公路-金獅湖站)

停車停車資訊:1F平面停車場、B1F地下停車場

5.竹北HOLA門市
新竹縣竹北市光明六路89號3F R

竹北HOLA 3樓

TEL: 03-558-3018

FAX: 03-558-3382

營業時間:11:00~22:00 (全年無休)

公車大眾運輸:新竹市區搭乘新竹客運往新埔或中壢方向車次，於竹北地政事務所下車 (步行約10分鐘)

停車停車資訊:竹北HOLA停車4-7F

6.台南仁德特力家居
台南市仁德區中山路777號B1F R

特力家居 地下1樓

TEL: 06-270-6335

FAX: 06-270-8765

營業時間:11:00~22:00 (全年無休)

公車大眾運輸:紅幹線公車-仁德交流道站(安工區-關廟).紅2公車-仁德交流道站(台南-上崙子-關廟).8050路公車-仁德交流道站(台南-旗山-佛光山)

停車停車資訊: 1F平面停車場、B1F地下停車場

7.高雄左營特力家居
高雄市左營區民族一路948之2號B1F R

高雄左營 特力家居 地下1樓

TEL: 07-347-5859

FAX: 07-347-7955

營業時間:11:00~22:00 (全年無休)

大眾運輸:3路公車-菜公路口站(美術館站-警廣站).72路公車-菜公路口站(獅甲國小-金獅湖站).91路公車-菜公路口站(大公路-金獅湖站)

停車資訊:1F平面停車場、B1F地下停車場

8.高雄夢時代門市
高雄市前鎮區中華五路789號B2F R

高雄夢時代 地下2樓 家居生活館內

TEL: 07-823-2053、07-970-0768

FAX: 07-970-1208

營業時間:11:00~22:00 (全年無休)

公車大眾運輸:1.15、36、70、214、中華幹線、168環狀東線/西線 請於夢時代站下車，即可抵達.2.25、69、12,3.168環狀東線/西線,4.168環狀東線/西線,5.請搭乘高雄捷運至R6(凱旋站)轉乘輕軌C3(前鎮之星站)至C5(夢時代站)下車

停車停車資訊:中華五路789號地下B1~B5

【地板產品資料】
"model": "D3597 TIMELESS OAK BEIGE 永恆貝格橡木", "color": "淺木色", "waterproof": False,"原價": 7880, "價格": 5880, "thickness": 10mm
"model": "KIWI 40522 Opal Oak Coffee 歐柏咖啡橡木", "color": "深木色", "waterproof": True, "原價": 7180, "價格": 5080, "thickness": 5.5mm
"model": "Oriental Oak White 東方白橡木", "color": "灰色", "waterproof": False , "原價": 6680, "價格": 4880, "thickness": 8mm
"""

# ======== 3. Webhook 接收區 ========
@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers['X-Line-Signature']
    body = request.get_data(as_text=True)
    handler.handle(body, signature)
    return 'OK'

# ======== 4. 訊息處理區 ========
@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    user_msg = event.message.text

    # 呼叫 OpenAI ChatGPT 來分析需求並推薦地板
    response = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        messages=[
            {"role": "system", "content": (
                "你是一位地板顧問，會根據使用者輸入進行公司介紹、地板知識說明或推薦產品"
                f"\n以下是你可參考的知識內容：\n\n{knowledge_text}"
            )},
            {"role": "user", "content": user_msg}
        ],
        temperature=0.7
    )

    reply = response['choices'][0]['message']['content']
    line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply))

if __name__ == "__main__":
    app.run(port=5000)
